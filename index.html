<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Amadori - Cancello</title>
  <style>
    body {
      margin: 0;
      padding: 20px;
      background-color: #28a745;
      font-family: Arial, sans-serif;
      color: white;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
    }

    img {
      max-width: 300px;
      height: auto;
      margin-top: 40px;
    }

    h2 {
      margin: 20px 0 10px;
      font-size: 22px;
      font-weight: normal;
    }

    .section-title {
      font-size: 24px;
      font-weight: bold;
      margin: 10px 0 30px;
    }

    #nameInput {
      padding: 12px 20px;
      font-size: 18px;
      border: 2px solid white;
      border-radius: 8px;
      background-color: white;
      color: #28a745;
      margin-bottom: 20px;
      width: 80%;
      max-width: 300px;
      text-align: center;
      font-weight: bold;
      display: none;
    }

    #nameInput::placeholder {
      color: #90d5a0;
      font-weight: normal;
    }

    button {
      padding: 15px 30px;
      font-size: 18px;
      background-color: #ffffff;
      color: #28a745;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      display: none;
    }

    button:hover {
      background-color: #e6e6e6;
    }

    #status, #closed, #geoError {
      font-size: 20px;
      margin-top: 30px;
      display: none;
    }

    .note {
      margin-top: 40px;
      font-size: 16px;
      max-width: 90%;
    }
  </style>
</head>
<body>

  <!-- Logo -->
  <img src="IMG_0139.PNG" alt="Logo Amadori">

  <h2>Allevamento di Morro D Oro</h2>
  <div class="section-title">Ingresso Manutentori</div>

  <!-- Campo nome manutentore -->
  <input type="text" id="nameInput" placeholder="Inserisci il tuo nome" maxlength="50">

  <button id="openGateBtn" onclick="apriCancello()">Apri Cancello</button>

  <div id="status">Il cancello si sta aprendo...</div>
  <div id="closed">Accesso non disponibile, torna più tardi.</div>
  <div id="geoError">Uhm, non sei davanti al cancello…</div>

  <div class="note">
    Ricorda di accettare/consentire la posizione attuale del tuo dispositivo per il corretto funzionamento.<br>
    Non premere il pulsante se non sei presente davanti al cancello.<br>
    Se non funziona, contattare il custode.
  </div>

  <script>
    const button = document.getElementById("openGateBtn");
    const nameInput = document.getElementById("nameInput");
    const statusMsg = document.getElementById("status");
    const closedMsg = document.getElementById("closed");
    const geoErrorMsg = document.getElementById("geoError");

    const latConsentita = 42.67624;
    const lonConsentita = 13.92359;
    const raggioInMetri = 1000;

    let geoWatcherId = null;
    let isPositionValid = false;

    function distanza(lat1, lon1, lat2, lon2) {
      const R = 6371e3;
      const rad = Math.PI / 180;
      const φ1 = lat1 * rad;
      const φ2 = lat2 * rad;
      const Δφ = (lat2 - lat1) * rad;
      const Δλ = (lon2 - lon1) * rad;

      const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                Math.cos(φ1) * Math.cos(φ2) *
                Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

      return R * c;
    }

    function isAccessAllowed() {
      const now = new Date();
      const day = now.getDay();
      const hour = now.getHours();
      return day >= 1 && day <= 6 && hour >= 7 && hour < 17;
    }

    function apriCancello() {
      const nome = nameInput.value.trim();
      if (!nome) {
        alert("Per favore, inserisci il tuo nome.");
        return;
      }

      button.style.display = "none";
      nameInput.style.display = "none";
      statusMsg.style.display = "block";
     
      // Chiamata IFTTT con il nome del manutentore
      // Il messaggio Telegram sarà: "[Nome] è appena entrato dal cancello della pesa"
      const message = encodeURIComponent(nome);
      fetch("https://maker.ifttt.com/trigger/Cancello/with/key/gnYYkYK-CXpD4U-5ROjNSCKbsiN5HJ8k8dVPoQklN4U?value1=" + message);
     
      localStorage.setItem("gateClickTime", Date.now().toString());
      localStorage.setItem("lastMaintainerName", nome);
    }

    function resetMessaggi() {
      button.style.display = "none";
      nameInput.style.display = "none";
      statusMsg.style.display = "none";
      closedMsg.style.display = "none";
      geoErrorMsg.style.display = "none";
      isPositionValid = false;
    }

    function checkButtonVisibility() {
      const nome = nameInput.value.trim();
      if (isPositionValid && nome.length > 0) {
        button.style.display = "inline-block";
      } else {
        button.style.display = "none";
      }
    }

    function checkAccess(lat, lon) {
      resetMessaggi();

      const distanzaUtente = distanza(lat, lon, latConsentita, lonConsentita);
      const lastClick = parseInt(localStorage.getItem("gateClickTime") || "0");
      const now = Date.now();
      const secondsPassed = (now - lastClick) / 1000;

      if (distanzaUtente <= raggioInMetri) {
        if (secondsPassed < 120) {
          statusMsg.style.display = "block";
        } else if (isAccessAllowed()) {
          // Mostra il campo nome solo se la posizione è corretta
          isPositionValid = true;
          nameInput.style.display = "block";
         
          // Ripristina l'ultimo nome usato se disponibile
          const lastMaintainerName = localStorage.getItem("lastMaintainerName");
          if (lastMaintainerName && !nameInput.value) {
            nameInput.value = lastMaintainerName;
          }
         
          checkButtonVisibility();
        } else {
          closedMsg.style.display = "block";
        }
      } else {
        geoErrorMsg.style.display = "block";
        geoErrorMsg.textContent = "Uhm, non sei davanti al cancello…";
      }
    }

    // Event listener per mostrare il pulsante quando viene inserito il nome
    nameInput.addEventListener("input", checkButtonVisibility);

    function startWatchingPosition() {
      if (navigator.geolocation) {
        geoWatcherId = navigator.geolocation.watchPosition(
          (position) => {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            checkAccess(lat, lon);
          },
          (error) => {
            resetMessaggi();
            geoErrorMsg.textContent = "Errore nella geolocalizzazione.";
            geoErrorMsg.style.display = "block";
          },
          { enableHighAccuracy: true, maximumAge: 10000, timeout: 5000 }
        );
      } else {
        geoErrorMsg.textContent = "Il tuo browser non supporta la geolocalizzazione.";
        geoErrorMsg.style.display = "block";
      }
    }

    function stopWatchingPosition() {
      if (geoWatcherId !== null) {
        navigator.geolocation.clearWatch(geoWatcherId);
        geoWatcherId = null;
      }
    }

    window.addEventListener("load", startWatchingPosition);

    document.addEventListener("visibilitychange", () => {
      if (document.visibilityState === "visible") {
        startWatchingPosition();
      } else {
        stopWatchingPosition();
      }
    });
  </script>

</body>
</html>
