<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content=
"width=device-width, initial-scale=1.0"
>
  <title>Amadori - Cancello</title>
  <style>
    body {
      margin: 0;
      padding: 20px;
      background-color: #28a745;
      font-family: Arial, sans-serif;
      color: white;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
    }

    img {
      max-width: 300px;
      height: auto;
      margin-top: 40px;
    }

    h2 {
      margin: 20px 0 10px;
      font-size: 22px;
      font-weight: normal;
    }

    .section-title {
      font-size: 24px;
      font-weight: bold;
      margin: 10px 0 30px;
    }

    #registrationContainer {
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 15px;
    }

    #nameSelect {
      padding: 12px 20px;
      font-size: 18px;
      border: 2px solid white;
      border-radius: 8px;
      background-color: white;
      color: #28a745;
      width: 80%;
      max-width: 300px;
      text-align: center;
      font-weight: bold;
      cursor: pointer;
    }

    #registerBtn {
      padding: 12px 25px;
      font-size: 16px;
      background-color: #ffffff;
      color: #28a745;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
    }

    #registerBtn:hover {
      background-color: #e6e6e6;
    }

    button {
      padding: 15px 30px;
      font-size: 18px;
      background-color: #ffffff;
      color: #28a745;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      display: none;
    }

    button:hover {
      background-color: #e6e6e6;
    }

    #status, #closed, #geoError {
      font-size: 20px;
      margin-top: 30px;
      display: none;
    }

    .note {
      margin-top: 40px;
      font-size: 16px;
      max-width: 90%;
    }

    .reset-link {
      margin-top: 20px;
      font-size: 14px;
      color: #ffffff;
      text-decoration: underline;
      cursor: pointer;
      display: none;
    }

    .reset-link:hover {
      color: #e6e6e6;
    }
  </style>
</head>
<body>

  <!-- Logo -->
  <img src="IMG_0139.PNG" alt="Logo Amadori">

  <h2>Allevamento di Morro D Oro</h2>
  <div class="section-title">Ingresso Manutentori</div>

  <!-- Container per registrazione primo accesso -->
  <div id="registrationContainer">
    <select id="nameSelect">
      <option value="">Seleziona il tuo nome</option>
      <option value="Maurizio">Maurizio</option>
      <option value="Mattia">Mattia</option>
      <option value="Alessio">Alessio</option>
    </select>
    <button id="registerBtn" onclick="registraDispositivo()">Registra Dispositivo</button>
  </div>

  <button id="openGateBtn" onclick="apriCancello()">Apri Cancello</button>

  <div id="status">Il cancello si sta aprendo...</div>
  <div id="closed">Accesso non disponibile, torna più tardi.</div>
  <div id="geoError">Uhm, non sei davanti al cancello…</div>

  <div class="reset-link" id="resetLink" onclick="cancellaRegistrazione()">
    Cambia utente/dispositivo
  </div>

  <div class="note">
    Ricorda di accettare/consentire la posizione attuale del tuo dispositivo per il corretto funzionamento.<br>
    Non premere il pulsante se non sei presente davanti al cancello.<br>
    Se non funziona, contattare il custode.
  </div>

  <script>
    const button = document.getElementById("openGateBtn");
    const registrationContainer = document.getElementById("registrationContainer");
    const nameSelect = document.getElementById("nameSelect");
    const registerBtn = document.getElementById("registerBtn");
    const statusMsg = document.getElementById("status");
    const closedMsg = document.getElementById("closed");
    const geoErrorMsg = document.getElementById("geoError");
    const resetLink = document.getElementById("resetLink");

    const latConsentita = 42.67624;
    const lonConsentita = 13.92359;
    const raggioInMetri = 1000;

    let geoWatcherId = null;

    // Genera un Device ID univoco
    function generateDeviceId() {
      return 'device-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
    }

    // Verifica se il dispositivo è già registrato
    function isDeviceRegistered() {
      return localStorage.getItem("deviceId") !== null && localStorage.getItem("maintainerName") !== null;
    }

    // Ottieni il nome del manutentore registrato
    function getRegisteredName() {
      return localStorage.getItem("maintainerName");
    }

    // Registra il dispositivo con il nome selezionato
    function registraDispositivo() {
      const selectedName = nameSelect.value;
      if (!selectedName) {
        alert("Per favore, seleziona il tuo nome.");
        return;
      }

      const deviceId = generateDeviceId();
      localStorage.setItem("deviceId", deviceId);
      localStorage.setItem("maintainerName", selectedName);
      
      // Ricarica lo stato
      location.reload();
    }

    // Cancella la registrazione del dispositivo
    function cancellaRegistrazione() {
      if (confirm("Sei sicuro di voler cancellare la registrazione di questo dispositivo?")) {
        localStorage.removeItem("deviceId");
        localStorage.removeItem("maintainerName");
        localStorage.removeItem("gateClickTime");
        location.reload();
      }
    }

    function distanza(lat1, lon1, lat2, lon2) {
      const R = 6371e3;
      const rad = Math.PI / 180;
      const φ1 = lat1 * rad;
      const φ2 = lat2 * rad;
      const Δφ = (lat2 - lat1) * rad;
      const Δλ = (lon2 - lon1) * rad;

      const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                Math.cos(φ1) * Math.cos(φ2) *
                Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

      return R * c;
    }

    function isAccessAllowed() {
      const now = new Date();
      const day = now.getDay();
      const hour = now.getHours();
      return day >= 1 && day <= 6 && hour >= 7 && hour < 18;
    }

    function apriCancello() {
      const nome = getRegisteredName();
      if (!nome) {
        alert("Errore: dispositivo non registrato.");
        return;
      }

      button.style.display = "none";
      resetLink.style.display = "none";
      statusMsg.style.display = "block";
      
      // Chiamata IFTTT con il nome del manutentore
      // Il messaggio Telegram sarà: "[Nome] è appena entrato dal cancello della pesa"
      const message = encodeURIComponent(nome + " è appena entrato dal cancello della pesa");
      fetch("https://maker.ifttt.com/trigger/Cancello/with/key/gnYYkYK-CXpD4U-5ROjNSCKbsiN5HJ8k8dVPoQklN4U?value1=" + message);
      
      localStorage.setItem("gateClickTime", Date.now().toString());
    }

    function resetMessaggi() {
      button.style.display = "none";
      registrationContainer.style.display = "none";
      statusMsg.style.display = "none";
      closedMsg.style.display = "none";
      geoErrorMsg.style.display = "none";
      resetLink.style.display = "none";
    }

    function checkAccess(lat, lon) {
      resetMessaggi();

      const distanzaUtente = distanza(lat, lon, latConsentita, lonConsentita);
      const lastClick = parseInt(localStorage.getItem("gateClickTime") || "0");
      const now = Date.now();
      const secondsPassed = (now - lastClick) / 1000;

      if (distanzaUtente <= raggioInMetri) {
        if (secondsPassed < 120) {
          // Cancello recentemente aperto
          statusMsg.style.display = "block";
        } else if (isAccessAllowed()) {
          // Orario di accesso consentito
          if (isDeviceRegistered()) {
            // Dispositivo già registrato - mostra pulsante apri cancello
            button.style.display = "inline-block";
            resetLink.style.display = "block";
          } else {
            // Dispositivo non registrato - mostra form di registrazione
            registrationContainer.style.display = "flex";
          }
        } else {
          // Orario non consentito
          closedMsg.style.display = "block";
        }
      } else {
        // Posizione non valida
        geoErrorMsg.style.display = "block";
        geoErrorMsg.textContent = "Uhm, non sei davanti al cancello…";
      }
    }

    function startWatchingPosition() {
      if (navigator.geolocation) {
        geoWatcherId = navigator.geolocation.watchPosition(
          (position) => {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            checkAccess(lat, lon);
          },
          (error) => {
            resetMessaggi();
            geoErrorMsg.textContent = "Errore nella geolocalizzazione.";
            geoErrorMsg.style.display = "block";
          },
          { enableHighAccuracy: true, maximumAge: 10000, timeout: 5000 }
        );
      } else {
        geoErrorMsg.textContent = "Il tuo browser non supporta la geolocalizzazione.";
        geoErrorMsg.style.display = "block";
      }
    }

    function stopWatchingPosition() {
      if (geoWatcherId !== null) {
        navigator.geolocation.clearWatch(geoWatcherId);
        geoWatcherId = null;
      }
    }

    window.addEventListener("load", startWatchingPosition);

    document.addEventListener("visibilitychange", () => {
      if (document.visibilityState === "visible") {
        startWatchingPosition();
      } else {
        stopWatchingPosition();
      }
    });
  </script>

</body>
</html>